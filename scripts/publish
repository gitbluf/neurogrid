#!/usr/bin/env bun

import { appendFileSync } from "fs"

const refName = process.env.GITHUB_REF_NAME
if (!refName) {
	console.error("GITHUB_REF_NAME is not set")
	process.exit(1)
}

const token = process.env.NPM_CONFIG_TOKEN
if (!token) {
	console.error("NPM_CONFIG_TOKEN is not set")
	process.exit(1)
}

const version = refName.replace(/^v/, "")
let tag = "latest"
if (version.includes("-")) {
	tag = version.split("-")[1].split(".")[0]
}

console.log(`Publishing v${version} with tag '${tag}'`)

appendFileSync(".npmrc", `\n//npm.pkg.github.com/:_authToken=${token}\n`)

const result = Bun.spawnSync(
	["bun", "publish", "--access", "public", "--tag", tag, "--tolerate-republish"],
	{ stdout: "inherit", stderr: "inherit" },
)

process.exit(result.exitCode ?? 1)
