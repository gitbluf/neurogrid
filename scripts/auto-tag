#!/usr/bin/env bun

const pkg = await Bun.file("package.json").json()
const version: string = pkg.version

if (!version || version === "null") {
	console.error("Could not read version from package.json")
	process.exit(1)
}

const tag = `v${version}`
console.log(`Detected version: ${version} (tag: ${tag})`)

const check = Bun.spawnSync(["git", "tag", "-l", tag], { stdout: "pipe" })
if (check.stdout.toString().trim() === tag) {
	console.log(`Tag ${tag} already exists, skipping`)
	process.exit(0)
}

function run(cmd: string[]) {
	const result = Bun.spawnSync(cmd, { stdout: "inherit", stderr: "inherit" })
	if (result.exitCode !== 0) {
		console.error(`Command failed: ${cmd.join(" ")}`)
		process.exit(result.exitCode ?? 1)
	}
}

console.log(`Creating and pushing tag ${tag}`)
run(["git", "config", "user.name", "github-actions[bot]"])
run(["git", "config", "user.email", "github-actions[bot]@users.noreply.github.com"])
run(["git", "tag", tag])
run(["git", "push", "origin", tag])
console.log(`Tag ${tag} pushed â€” release workflow should trigger`)
