#!/usr/bin/env bun

const RED = "\x1b[0;31m"
const GREEN = "\x1b[0;32m"
const YELLOW = "\x1b[0;33m"
const NC = "\x1b[0m"

function usage(): void {
  console.log(`${YELLOW}Usage:${NC} bun run release <version>`)
  console.log("  Example: bun run release 0.2.0")
  console.log("  Example: bun run release 1.0.0-rc.1")
}

function error(msg: string): void {
  console.error(`${RED}Error:${NC} ${msg}`)
}

function info(msg: string): void {
  console.log(`${YELLOW}${msg}${NC}`)
}

function success(msg: string): void {
  console.log(`${GREEN}${msg}${NC}`)
}

async function exec(cmd: string[]): Promise<void> {
  const proc = Bun.spawn(cmd, { stdout: "inherit", stderr: "inherit" })
  const code = await proc.exited
  if (code !== 0) {
    error(`Command failed: ${cmd.join(" ")}`)
    process.exit(code)
  }
}

async function execQuiet(cmd: string[]): Promise<boolean> {
  const proc = Bun.spawn(cmd, { stdout: "pipe", stderr: "pipe" })
  const code = await proc.exited
  return code === 0
}

const SEMVER_REGEX = /^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z]+(\.[0-9A-Za-z]+)*)?$/

const version = process.argv[2]

if (!version) {
  usage()
  error("A single semver version is required.")
  process.exit(1)
}

if (!SEMVER_REGEX.test(version)) {
  usage()
  error("Version must be valid semver (e.g. 1.0.0, 1.0.0-rc.1).")
  process.exit(1)
}

const workingClean = await execQuiet(["git", "diff", "--quiet"])
const stagingClean = await execQuiet(["git", "diff", "--cached", "--quiet"])

if (!workingClean || !stagingClean) {
  error("Working tree is dirty. Commit or stash changes first.")
  process.exit(1)
}

info(`Updating package.json version to ${version}...`)
const pkgPath = "package.json"
const pkg = await Bun.file(pkgPath).json()
pkg.version = version
await Bun.write(pkgPath, JSON.stringify(pkg, null, 2) + "\n")

info("Committing version bump...")
await exec(["git", "add", "package.json"])
await exec(["git", "commit", "-m", `release: v${version}`])

info(`Creating tag v${version}...`)
await exec(["git", "tag", `v${version}`])

info("Pushing commit and tag...")
await exec(["git", "push", "origin", "HEAD"])
await exec(["git", "push", "origin", `v${version}`])

success(`Release v${version} created and pushed.`)
